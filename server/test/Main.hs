module Main (main) where

import Api (app, applyArgs, estimateTxFees)
import Data.ByteString.Lazy.Char8 qualified as LC8
import Data.Kind (Type)
import Network.HTTP.Client (defaultManagerSettings, newManager)
import Network.HTTP.Types (Status (Status))
import Network.Wai.Handler.Warp (Port)
import Network.Wai.Handler.Warp qualified as Warp
import Plutus.V1.Ledger.Api qualified as Ledger
import Servant.Client (
  BaseUrl (baseUrlPort),
  ClientEnv,
  ClientError (FailureResponse),
  ClientM,
  ResponseF (Response),
  mkClientEnv,
  parseBaseUrl,
  runClientM,
 )
import System.Exit (die)
import Test.Hspec (
  ActionWith,
  Spec,
  around,
  context,
  describe,
  hspec,
  it,
  pendingWith,
  runIO,
  shouldBe,
  shouldSatisfy,
 )
import Test.Hspec.Core.Spec (SpecM)
import Types (
  AppliedScript (AppliedScript),
  ApplyArgsRequest (ApplyArgsRequest, args, script),
  Cbor (Cbor),
  Env,
  Fee (Fee),
  newEnvIO,
  unsafeDecode,
 )

main :: IO ()
main = hspec serverSpec

serverSpec :: Spec
serverSpec = do
  describe "Api.Handlers.applyArgs" applyArgsSpec
  describe "Api.Handlers.estimateTxFees" feeEstimateSpec

applyArgsSpec :: Spec
applyArgsSpec = around withTestApp $ do
  clientEnv <- setupClientEnv

  context "POST /apply-args" $ do
    it "returns the same script when called without args" $ \port -> do
      result <-
        runClientM' (clientEnv port) $
          applyArgs unappliedRequestFixture
      result `shouldBe` Right (AppliedScript unappliedScriptFixture)

    it "returns the correct partially applied Plutus script" $ \_ -> do
      pendingWith "TODO"

    it "returns the correct fully applied Plutus script" $ \_ -> do
      pendingWith "TODO"

feeEstimateSpec :: Spec
feeEstimateSpec = around withTestApp $ do
  clientEnv <- setupClientEnv

  context "GET /fees" $ do
    it "estimates the correct fee" $ \port -> do
      result <-
        runClientM' (clientEnv port) $
          estimateTxFees cborTxFixture
      -- This is probably incorrect. See:
      -- https://github.com/Plutonomicon/cardano-browser-tx/issues/123
      result `shouldBe` Right (Fee 168449)

    it "catches invalid hex strings" $ \port -> do
      result <-
        runClientM' (clientEnv port)
          . estimateTxFees
          $ Cbor "deadbeefq"
      result `shouldSatisfy` expectError 400 "invalid bytestring size"

    it "catches invalid CBOR-encoded transactions" $ \port -> do
      result <-
        runClientM' (clientEnv port)
          . estimateTxFees
          $ Cbor "deadbeef"
      result
        `shouldSatisfy` expectError
          400
          "DecoderErrorDeserialiseFailure \"Shelley Tx\" \
          \(DeserialiseFailure 0 \"expected list len or indef\")"
  where
    expectError :: Int -> LC8.ByteString -> Either ClientError Fee -> Bool
    expectError code body = \case
      Left (FailureResponse _ (Response (Status scode _) _ _ sbody))
        | scode == code && sbody == body -> True
      _ -> False

setupClientEnv :: SpecM Port (Port -> ClientEnv)
setupClientEnv = do
  baseUrl <- runIO $ parseBaseUrl "http://localhost"
  manager <- runIO $ newManager defaultManagerSettings
  pure $
    let clientEnv port = mkClientEnv manager $ baseUrl {baseUrlPort = port}
     in clientEnv

withTestApp :: ActionWith (Port -> IO ())
withTestApp = Warp.testWithApplication $ app <$> newEnvIO'
  where
    newEnvIO' :: IO Env
    newEnvIO' = either die pure =<< newEnvIO

runClientM' ::
  forall (a :: Type).
  ClientEnv ->
  ClientM a ->
  IO (Either ClientError a)
runClientM' = flip runClientM

unappliedRequestFixture :: ApplyArgsRequest
unappliedRequestFixture =
  ApplyArgsRequest
    { script = unappliedScriptFixture
    , args = []
    }

-- This is a known-good 'Tx AlonzoEra'
cborTxFixture :: Cbor
cborTxFixture =
  Cbor $
    mconcat
      [ "84a500818258205d677265fa5bb21ce6d8c7502aca70b9316d10e958611f3c6b758f65a"
      , "d959996000d818258205d677265fa5bb21ce6d8c7502aca70b9316d10e958611f3c6b75"
      , "8f65ad95999600018282581d600f45aaf1b2959db6e5ff94dbb1f823bf257680c3c723a"
      , "c2d49f975461a0023e8fa82581d60981fc565bcf0c95c0cfa6ee6693875b60d529d87ed"
      , "7082e9bf03c6a41a000f4240021a0002b5690e81581c0f45aaf1b2959db6e5ff94dbb1f"
      , "823bf257680c3c723ac2d49f97546a10081825820096092b8515d75c2a2f75d6aa7c519"
      , "1996755840e81deaa403dba5b690f091b6584063721fd9360d569968defac287e76cfaa"
      , "767366ecf6709b8354e02e2df6c35d78453adb04ec76f8a3d1287468b8c244ff051dcd0"
      , "f29dbcac1f7baf3e2d06ce06f5f6"
      ]

-- A minting policy without any arguments applied
unappliedScriptFixture :: Ledger.Script
unappliedScriptFixture =
  unsafeDecode
    "Script"
    $ mconcat
      [ "\""
      , "590a9a01000032333222323232323233223233223232333222333222333222"
      , "33223233322232323322323233223233333222223322333332222233223322"
      , "33223232323232222222223235300f00222353013002222232222222333353"
      , "02901023232323232300100e3200135505a2253353503e0011533530593335"
      , "303d12001051500332635302e3357389210b756e726561636861626c650002"
      , "f01f150051500422135355054002225335305d333573466e3c009406417c17"
      , "854cd4c174ccd4c10448004155401c00454024540204c01800c4cd40f0cd54"
      , "140c0d4010cdc0a40009001281e8a99a982a99ab9c4901124e4654206d7573"
      , "74206265206275726e6564000561500110561533530543301b00f353035002"
      , "2220011500115335305433573892011f4f776e6572206d757374207369676e"
      , "20746865207472616e73616374696f6e000551500110551533530533335530"
      , "1c120013502f50482353022001222533530573303f00333041304901a50431"
      , "0581333573466e1cccc07000806cd4c0e001488800d200205905800b105513"
      , "357389211f556e6465726c79696e67204e4654206d75737420626520756e6c"
      , "6f636b656400054232323232323225335305a33300f00835303b0082220020"
      , "011500215335305a33573892013e45786163746c79206f6e65206e65772074"
      , "6f6b656e206d757374206265206d696e74656420616e642065786163746c79"
      , "206f6e65206f6c64206275726e740005b15002105b15335305833004500233"
      , "042304a018504415335305833004500133042304b01a504415335305833355"
      , "30211200135034504d3300533042304b35303900622200150443370266e054"
      , "00cc1514004c151400804041685415854158541584cdc199b8250020184828"
      , "270044cdc199b8250010154828270044d4c0d800c888008894cd4c158ccd5c"
      , "d19b880020530580571058133355301f1200135032504b3300300100200e22"
      , "23530240012225335305933041006003153353059333573466e1c014ccc078"
      , "0080e40e416c16854cd4d4110004854cd4d4114d4c09805488888888894cd4"
      , "d413cccd54c0b44800540b08d4d54178004894cd4c19cccd5cd19b8f00200e"
      , "0690681350540031505300221350523535505e001220011505021323335734"
      , "66ebc008004178174c8d4d5415400488cdd2a400066ae80dd480119aba0375"
      , "20026ec4090cd54155405cc0e8024416c4168416841688c894cd4c154ccc02"
      , "800c004d4c0d800c8880045400854cd4c154cd5ce2493e45786163746c7920"
      , "6f6e65206e657720746f6b656e206d757374206265206d696e74656420616e"
      , "642065786163746c79206f6e65206f6c64206275726e740005615002105615"
      , "33530533301a00e353034001222001105513357389211f4f776e6572206d75"
      , "7374207369676e20746865207472616e73616374696f6e0005423232323230"
      , "0100d320013550592253353503d001153353503d32635302d3357389210b75"
      , "6e726561636861626c650002e01e150042213300500200122135355053002"
      , "225335305c333573466e3c009406017817454cd4d410400454020884cc0240"
      , "080044c01800c88d4d54140008894cd4d40f800c54cd4c164ccd5cd19b8f00"
      , "2303800705b05a153353059333573466e1c005200205b05a15006150051500"
      , "5221500715335305433573892011e45786163746c79206f6e65204e4654206"
      , "d757374206265206d696e7465640005515001105515335305333355301c120"
      , "013502f50482353022001222533530573303f00333041304901a5043133357"
      , "3466e1cccc07000806cd4c0e001488800d2002059058105800b10551335738"
      , "9211d556e6465726c79696e67204e4654206d757374206265206c6f636b656"
      , "4000542322232323001007320013550532253353503700110532213535504d"
      , "0022253353056333573466e3c009404816015c54cd4d40ec004415c884d4d5"
      , "4144008894cd4d40fc00c416c884d4d5415400888c94cd4d411001054cd4c1"
      , "7cccd5cd19b8f007501306106015335305f333573466e3c00d404018418054"
      , "cd4c17cccd5cd19b87006480041841804ccd5cd19b87002480081841804180"
      , "540045400488418854cd4c178ccd5cd19b8f002501206005f15335305e3335"
      , "73466e3c019403c18017c54cd4c178ccd5cd19b870014800418017c4ccd5cd"
      , "19b870054800818017c417c417c417c4c01800c4c0b8d4c0c0010888ccc0d0"
      , "00c0140104c0ac0044d4c03800488cccd4c0580048c98d4c070cd5ce249024"
      , "c680001d00d2001232635301c3357389201024c680001d00d232635301c335"
      , "7389201024c680001d00d22232323001005320013550422233535026001480"
      , "0088d4d540f0008894cd4c114ccd5cd19b8f00200904704613007001130060"
      , "033200135504122335350250014800088d4d540ec008894cd4c110ccd5cd19"
      , "b8f00200704604510011300600349888d4c01c00888888888894cd4d40c0cc"
      , "d54c03848005403494cd4c118ccd5cd19b8f00c00104804713503300115032"
      , "00321048104613350162253353502500221003100150243200135503a22112"
      , "22533535021001135350190032200122133353501b00522002300400233355"
      , "30071200100500400122123300100300220012222222222123333333333001"
      , "00b00a00900800700600500400300220012221233300100400300220012122"
      , "22300400521222230030052122223002005212222300100520011200120012"
      , "12222300400522122223300300600522122223300200600521222230010052"
      , "001123350032233353501d00322002002001353501b0012200112212330010"
      , "030021200123724666aa600a24002e28008cc88cc008c8dc9198120008029a"
      , "9802801911001198011b923530050032220013300237246a600a0064440060"
      , "02a010a0129110022212333001004003002200132001355020221122253353"
      , "5007001100222133005002333553007120010050040013200135501f221222"
      , "53353500600215335350060011023221024221533535008003102422153353"
      , "02533007004002133353009120010070030011026112200212212233001004"
      , "00312001223530030022235300500322323353010005233530110042533530"
      , "21333573466e3c00800408c0885400c408880888cd4c044010808894cd4c08"
      , "4ccd5cd19b8f00200102302215003102215335350090032153353500a00221"
      , "335300e0022335300f00223353013002233530140022330180020012025233"
      , "53014002202523301800200122202522233530110042025222533530263335"
      , "73466e1c01800c0a009c54cd4c098ccd5cd19b870050020280271330210040"
      , "01102710271020153353500900121020102022123300100300220011212230"
      , "02003112200112001212230020032221223330010050040032001212230020"
      , "0321223001003200122333573466e3c00800404003c4cd4008894cd4c03400"
      , "8403c400403048848cc00400c0084800488d4d5400c00888d4d5401400c894"
      , "cd4c038ccd5cd19b8f00400201000f133009003001100f1122123300100300"
      , "211200122333573466e1c00800402402094cd4c014ccd5cd19b88001002007"
      , "0061480004005208092f401133573892113526f79616c6974696573206e6f7"
      , "42070616964000033200135500422253353004333573466e20009208004006"
      , "00513371600400226600666e0c0092080043371666e1800920800400112200"
      , "21220012001112323001001223300330020020011"
      , "\""
      ]
